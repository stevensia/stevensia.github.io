<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="个人技术总结，读书笔记，心得等 | 这里是 Stevensia的个人博客，与君共勉。">
    <meta name="keyword"  content="Python, Steven的博客, Steven Blog, linux">
    <link rel="shortcut icon" href="img/favicon.ico">

    <title>Mongodb基础知识总结 - Steven's Blog!</title>

    <link rel="canonical" href="http://universus.cn/mongodb/2016/01/04/mongo-basic/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Steven's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About me</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/in-post/eliot-horowitz.png" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/in-post/eliot-horowitz.png')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-9 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#mongodb" title="mongodb">mongodb</a>
                        
                    </div>
                    <h1>Mongodb基础知识总结</h1>
                    
                    
                    <h2 class="subheading">Mongodb基础知识小结-学而时习之!</h2>
                    
                    <span class="meta">Posted by Steven's Blog on January 4, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-9 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<blockquote>
  <p>最好的自己，因为你即你选择。这些年，我一直坚持的一个信念是，改变不了大环境，就改变小环境，做自己力所能及的事情。你不能决定太阳几点升起，但可以决定自己几点起床。–《自由在高处》</p>
</blockquote>

<h1 id="section">一.基本概念</h1>

<h2 id="section-1">1.1 文档</h2>

<p><strong>文档是mongodb中数据的基本单元，类似于关系型数据库的行</strong>。</p>

<p>关于文档的键的说明：</p>

<ul>
  <li>键是字符串，任意的UTF-8字符</li>
  <li>键不能包括<code>\0</code>(空字符串)，表示键的结尾</li>
  <li>键不能包括<code>.</code>,<code>$</code>等特殊字符，它们都是mongodb保留字</li>
</ul>

<p><strong>mongodb区分类型和大小写</strong></p>

<pre><code>{"foo": 3} != {"foo": "3"} != {"Foo": 3}
</code></pre>

<p><strong>mongodb不能有重复的键</strong></p>

<pre><code>{"foo": 3, "bar": 4, "foo": 100}   // 非法
</code></pre>

<p><strong>文档中键值对是有序的</strong></p>

<pre><code>{"x":1, "y":2} != {"y":2, "x":1}
</code></pre>

<h2 id="section-2">1.2 集合</h2>

<p>集合(collection)可以看做动态模式(dynamic schema， 意味着里面的文档是各式各样的)的表, 是一组文档。关于文档的命名与集合的命名<strong>基本一致</strong>，但是还包括如下：</p>

<ul>
  <li>与文档命名基本一致</li>
  <li>不能以<code>system.</code>开头，因为这是系统保留的前缀，如system.users存储用户信息，system.namespaces存储集合信息等</li>
</ul>

<p>集合还能包括<strong>子集合</strong>，以<code>.</code>来分割，如blog集合，下blog.users和blog.posts集合，<strong>子集合没有啥特殊属性，往往作为一个管理和定义等，但是推荐使用。</strong> 如：</p>

<ul>
  <li>GridFS, 用子集合存储文件的元数据，这样就能与文件内容块很好的隔离开</li>
  <li>驱动程序的语法糖，如shell中，db.blog表示blog集合，db.blog.users表示博客用户子集合。</li>
</ul>

<h2 id="section-3">1.3 数据库</h2>

<p>多个集合就组成了数据库，数据库可以有多个，对应0或多个集合，每个数据库都是独立的，有独立的权限。</p>

<p>数据库的命名<strong>与集合类似</strong>，除此之外要注意，<strong>区分大小写，最好小写命名，不超过64个字节。</strong></p>

<p>要注意：<strong>数据库最终会成为文件系统的一个文件，而数据库名就对应的是文件名，文件怎么命名的数据库就应该怎么命名。</strong></p>

<h2 id="section-4">1.4 基础配置和管理</h2>

<p>运行<code>mongod</code>命令启动该服务，默认数据目录是/data/db;默认端口<code>27017</code></p>

<p>运行<code>mongo</code>则启动mongodb shell,该shell是<strong>一个Javascript解释器，可以运行js程序。</strong></p>

<p>启动时，shell默认连接test数据库，并将数据库连接赋值给全局变量<code>db</code>.</p>

<pre><code>// 查看当前数据库
&gt; db
test

// 切换数据库
&gt; use foo
switched to db foo
&gt; db
foo

//访问集合:db.yourCollection
//集合操作:db.yourCollection.xxx
</code></pre>

<p>查看帮助：</p>

<pre><code>&gt; db.help() // 数据库帮助
DB methods:
	db.adminCommand(nameOrDocument) - switches to 'admin' db, and runs command [ just calls db.runCommand(...) ]
	db.auth(username, password)
	db.cloneDatabase(fromhost)
 
&gt; db.foo.help() //集合帮助
DBCollection help
	db.foo.find().help() - show DBCursor help
	db.foo.count()

&gt; db.foo.find //查看函数级别
</code></pre>

<h1 id="section-5">二.数据类型</h1>

<h2 id="section-6">2.1 基础数据类型</h2>
<p>类JSON, 而JSON的基础数据类型为：<code>null</code>,布尔值，数字，字符串，数组和对象。往往能处理大多数情况，但JSON的局限在于：</p>

<ul>
  <li>没有日期类型</li>
  <li>只有一种数字类型，无法区分浮点数和整数</li>
  <li>无法表示通用类型如正则或函数</li>
</ul>

<p><strong>mongodb保留了JSON基本键值对特性，添加了其他数据类型：</strong></p>

<ul>
  <li>null: 表示空值或不存在的字段， <code>{"x":null}</code></li>
  <li>布尔值：true和false</li>
  <li>数值：默认64位浮点数， {“x”: 3.14},对于整型在shell中可使用js的NumberInt(4位),NumberLong(8位)，如：{“x”:NumberInt(“3”)}</li>
  <li>字符串：UTF-8字符串</li>
  <li>日期：存储为自新纪元以来进过的毫秒数，不存储时区， {“x”: new Date()}</li>
  <li>正则表达式：与Js正则语法类似，{“x”: /foo/i}</li>
  <li>数组</li>
  <li>内嵌文档</li>
  <li>对象id： {“x”: ObjectId()}</li>
  <li>二进制数据</li>
  <li>代码：仅内部使用</li>
</ul>

<h1 id="crud">三.CRUD</h1>

<h2 id="section-7">3.1 插入文档</h2>

<p><code>insert</code>命令，会自动添加一个<code>_id</code>键。</p>

<pre><code>&gt; db.foo.insert({"bar": "baz"})
WriteResult({ "nInserted" : 1 })

&gt; i = {"name": "beginman", "age": 24}
{ "name" : "beginman", "age" : 24 }

&gt; db.foo.insert(i)
WriteResult({ "nInserted" : 1 })

&gt; db.foo.save(i)
WriteResult({ "nInserted" : 1 })
</code></pre>

<p>如果批量插入则以列表形式：</p>

<pre><code>&gt;&gt; db.foo.insert([{"v1": 100}, {"v2": 200}, {"v3": 300}])
</code></pre>

<p>还可以<a href="http://docs.mongoing.com/manual/tutorial/insert-documents.html#insert-multiple-documents-with-bulk">用<code>Bulk</code> 插入多个文档</a></p>

<h2 id="section-8">3.2 删除文档</h2>

<p>db.foo.remove({}): 空的查询文档<code>{}</code>删除foo集合中所有文档，但不会删除集合本身，也不会删除集合元信息。</p>

<p>db.foo.remove({“name”: “fang”}) 删除指定集合。</p>

<p>如果要清空整个集合用<code>db.drop()</code>直接删除集合会比较快。</p>

<p>要想删除单个文档，可以调用 remove() 方法，然后把 justOne 参数设置为 true 或 <code>.</code>。</p>

<pre><code>db.inventory.remove( { type : "food" }, 1 )
</code></pre>

<h2 id="section-9">3.3 更新文档</h2>

<p>MongoDB 使用 <code>update()</code> 和 <code>save()</code> 方法来更新集合中的文档.</p>

<h3 id="update-">3.3.1 update() 方法</h3>

<pre><code>db.collection.update(
   &lt;query&gt;,
   &lt;update&gt;,
   {
     upsert: &lt;boolean&gt;,
     multi: &lt;boolean&gt;,
     writeConcern: &lt;document&gt;
   }
)
</code></pre>

<p>参数说明：</p>

<ul>
  <li>query : update的查询条件，类似sql update查询内where后面的。</li>
  <li>update : update的对象和一些更新的操作符（如$,$inc…）等，也可以理解为sql update查询内set后面的</li>
  <li>upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。</li>
  <li>multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。</li>
  <li>writeConcern :可选，抛出异常的级别。</li>
</ul>

<h3 id="save-">3.3.2 save() 方法</h3>
<p>save() 方法通过传入的文档来替换已有文档。语法格式如下：</p>

<pre><code>db.collection.save(
   &lt;document&gt;,
   {
     writeConcern: &lt;document&gt;
   }
)
</code></pre>

<p>参数说明：</p>

<ul>
  <li>document : 文档数据。</li>
  <li>writeConcern :可选，抛出异常的级别。</li>
</ul>

<h3 id="set">3.3.3 $set修改器</h3>

<p><code>$set</code>指定一个字段的值，如果该字段不存在则创建，存在则修改。如下：</p>

<pre><code>&gt; db.foo.find({"name": "beginman"})
{ "_id" : ObjectId("5689ec760c45f69abd830053"), "name" : "beginman", "age" : 25 }
{ "_id" : ObjectId("5689ec810c45f69abd830054"), "name" : "beginman", "age" : 24 }

//批量修改
&gt; db.foo.update({"name": "beginman"}, {"$set": {"age": 25}}, {"multi": 1})
WriteResult({ "nMatched" : 2, "nUpserted" : 0, "nModified" : 1 })

//修改内嵌文档
&gt; db.foo.find({_id: ObjectId("568a05450c45f69abd830057")}).pretty()
{
	"_id" : ObjectId("568a05450c45f69abd830057"),
	"name" : "beginman",
	"age" : 24,
	"read" : {
		"title" : "Python CookBook",
		"star" : "☆☆☆☆☆"
	}
}
&gt; db.foo.update({_id: ObjectId("568a05450c45f69abd830057")}, {"$set": {"read.title": "Redis In Action"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
&gt; db.foo.find({_id: ObjectId("568a05450c45f69abd830057")}).pretty()
{
	"_id" : ObjectId("568a05450c45f69abd830057"),
	"name" : "beginman",
	"age" : 24,
	"read" : {
		"title" : "Redis In Action",
		"star" : "☆☆☆☆☆"
	}
}
</code></pre>

<p><strong><code>$unset</code>:删除指定的键</strong></p>

<pre><code>&gt; db.foo.update({"name": "beginman"}, {"$unset": {"age": 1}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
&gt; db.foo.find({"name": "beginman"})
{ "_id" : ObjectId("5689ec760c45f69abd830053"), "name" : "beginman" }
{ "_id" : ObjectId("5689ec810c45f69abd830054"), "name" : "beginman", "age" : 25 }
</code></pre>

<h3 id="inc">3.3.4 $inc递增递减</h3>
<p><code>$inc</code>用于增加数值，如果不存在则创建。</p>

<pre><code>&gt; db.foo.update({"name": "beginman"}, {"$inc": {"view": 0}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"name": "beginman"})
{ "_id" : ObjectId("5689ec810c45f69abd830054"), "name" : "beginman", "age" : 25, "view" : 0 }
{ "_id" : ObjectId("568a05450c45f69abd830057"), "name" : "beginman", "age" : 24, "read" : { "title" : "Redis In Action", "star" : "☆☆☆☆☆" } }
</code></pre>

<p>如果递减数值，则<code>$inc</code>后面应该是负数。</p>

<h3 id="push">3.3.5 $push向数组添加元素</h3>
<p>如果数组已经存在则<code>$push</code>向其尾部添加元素，不存在则创建。</p>

<pre><code>&gt; db.foo.find({"name": "Jack"}).pretty()
{
	"_id" : ObjectId("568a08ae0c45f69abd830058"),
	"name" : "Jack",
	"age" : 26,
	"read" : [
		{
			"title" : "Python CookBook",
			"star" : "☆☆☆☆☆"
		}
	]
}

//添加读书
&gt; db.foo.update(
	{"name": "Jack"}, 
	{"$push": {"read": {"title": "Redis In Action", "star": "☆☆☆"}}}
)
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"name": "Jack"}).pretty()
{
	"_id" : ObjectId("568a08ae0c45f69abd830058"),
	"name" : "Jack",
	"age" : 26,
	"read" : [
		{
			"title" : "Python CookBook",
			"star" : "☆☆☆☆☆"
		},
		{
			"title" : "Redis In Action",
			"star" : "☆☆☆"
		}
	]
}
</code></pre>

<p>这是<code>$push</code>的基本用法，还可以配合<strong><code>$each</code>(用来循环)，实现批量push.</strong></p>

<pre><code>//添加成绩
&gt; db.foo.update(
	{"name": "Jack"}, 
	{"$push": {"scores": 
				{"$each": [{"math": 98.8}, 
							{"english":100}, 
							{"C/C++": 99.3}]}
				}
	}
)

WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
&gt; db.foo.find({"name": "Jack"}).pretty()
{
	"_id" : ObjectId("568a08ae0c45f69abd830058"),
	"name" : "Jack",
	"age" : 26,
	"read" : [
		{
			"title" : "Python CookBook",
			"star" : "☆☆☆☆☆"
		},
		{
			"title" : "Redis In Action",
			"star" : "☆☆☆"
		}
	],
	"scores" : [
		{
			"math" : 98.8
		},
		{
			"english" : 100
		},
		{
			"C/C++" : 99.3
		}
	]
}
</code></pre>

<p><strong>如果希望数组长度是固定的，则可用<code>$slice</code>限定长度</strong>：</p>

<pre><code>&gt; db.foo.update({"name": "Rose"},
... {"$push": {"top10": {
...     "$each": ["England", "Beijing", "SanYa"],
...     "$slice": -2}}})


&gt; db.foo.find({"name": "Rose"})
{ "_id" : ObjectId("568a0d700c45f69abd830059"), "name" : "Rose", "top10" : [ "Beijing", "SanYa" ] }
</code></pre>

<p><code>$slice</code>后面必须是负整数，限制数组只包括最后加入的2个元素。</p>

<h3 id="section-10">3.3.6 将数组作为数据集使用</h3>

<p>关于数组操作可参考<a href="https://docs.mongodb.org/v3.0/reference/operator/update-array/"><strong>Array Update Operators¶</strong></a></p>

<p><strong>插入元素：</strong></p>

<p>有时候为了保证数组元素的唯一性，使用<code>$ne</code>(not equal), <a href="https://docs.mongodb.org/v3.0/reference/operator/query/ne/">参考文档详细</a>,<code>$ne</code>语法如下：</p>

<pre><code>{field: {$ne: value} }
//$ne selects the documents where the value of the field is not equal (i.e. !=) to the specified value. 
//This includes documents that do not contain the field.
</code></pre>

<p>etc:</p>

<pre><code>db.foo.find( { age: { $ne: 24 } } )
</code></pre>

<p>如果对于数组则可以用<code>$addToSet</code>,”$addToSet”也可用来插入数组元素，与”$push”不同的是，当要插入的元素在数组中已经存在时，”$addToSet”就不会再次插入。可以用来避免重复。</p>

<p><strong>删除元素：</strong></p>

<p>可以使用:</p>

<ul>
  <li><code>$pop</code>(Removes the first or last item of an array., <a href="https://docs.mongodb.org/v3.0/reference/operator/update/pop/#up._S_pop">文档地址</a>)</li>
  <li><code>$pullAll</code>(Removes all matching values from an array.,<a href="https://docs.mongodb.org/v3.0/reference/operator/update/pullAll/#up._S_pullAll">文档地址</a>)</li>
  <li><code>$pull</code>(Removes all array elements that match a specified query.<a href="https://docs.mongodb.org/v3.0/reference/operator/update/pull/#up._S_pull">文档地址</a>)</li>
</ul>

<p><code>$pop</code>操作：{“$pop”: {“arrayKey”: 1}}:</p>

<pre><code>&gt; db.foo.find({"_id": 1})
{ "_id" : 1, "scores" : [ 8, 9, 10 ] }

// -1从数组头部删除
&gt; db.foo.update({"_id": 1}, {$pop: {"scores": -1}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"_id": 1})
{ "_id" : 1, "scores" : [ 9, 10 ] }

// 1从数组末尾删除
&gt; db.foo.update({"_id": 1}, {$pop: {"scores": 1}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"_id": 1})
{ "_id" : 1, "scores" : [ 9 ] }
&gt; 
</code></pre>

<p><code>$push</code>删除指定元素, <code>$pushAll</code>删除全部指定元素</p>

<pre><code>&gt; db.foo.find({"_id": 2})
{ "_id" : 2, "learn" : [ "java", "python", "c", "js", "go", "java" ] }

//删除c
&gt; db.foo.update({"_id": 2}, {"$pull": {"learn": "c"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"_id": 2})
{ "_id" : 2, "learn" : [ "java", "python", "js", "go", "java" ] }

//删除js和go
&gt; db.foo.update({"_id": 2}, {"$pullAll": {"learn": ["js", "go"]}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
&gt; db.foo.find({"_id": 2})
{ "_id" : 2, "learn" : [ "java", "python", "java" ] }

//删除java
&gt; db.foo.update({"_id": 2}, {"$pull": {"learn": "java"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
&gt; db.foo.find({"_id": 2})
{ "_id" : 2, "learn" : [ "python" ] }
</code></pre>

<p><strong>基于位置的数组修改器</strong></p>

<p>如果数组有多个值，我们只想对其中一部分进行修改，则<strong>可通过位置或者定位操作符(“$”)</strong></p>

<p>基于位置：arrayName.index.key, 如对元素0上增加10个投票(comments.0.vote)</p>

<pre><code>&gt; db.foo.find({"book": "python cookbook"}).pretty()
{
	"_id" : ObjectId("568a17b90c45f69abd83005b"),
	"book" : "python cookbook",
	"comments" : [
		{
			"name" : "Jack",
			"vote" : 1,
			"content" : "good"
		},
		{
			"name" : "Rose",
			"vote" : 3,
			"content" : "very well"
		}
	]
}

&gt; db.foo.update({"book": "python cookbook"}, {"$inc": {"comments.0.vote": 10}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"book": "python cookbook"}).pretty()
{
	"_id" : ObjectId("568a17b90c45f69abd83005b"),
	"book" : "python cookbook",
	"comments" : [
		{
			"name" : "Jack",
			"vote" : 11,
			"content" : "good"
		},
		{
			"name" : "Rose",
			"vote" : 3,
			"content" : "very well"
		}
	]
}
</code></pre>

<p>但是一般情况下需要查询一遍才知道数组的下标，对于不知道下标的情况最好使用定位操作符<code>$</code>,基于定位操作符<code>$</code>可更新只匹配上的元素(comments.$.name)。如将评论人为Rose改成Lucy.</p>

<pre><code>&gt; db.foo.update(
	{ "comments.name": "Rose" }, 
	{"$set":  
		{"comments.$.name": "Lucy"}})

WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })

&gt; db.foo.find({"book": "python cookbook"}).pretty()
{
	"_id" : ObjectId("568a17b90c45f69abd83005b"),
	"book" : "python cookbook",
	"comments" : [
		{
			"name" : "Jack",
			"vote" : 11,
			"content" : "good"
		},
		{
			"name" : "Lucy",
			"vote" : 3,
			"content" : "very well"
		}
	]
}
</code></pre>

<p><strong>定位符只更新第一个匹配的元素</strong>。如果评论里面有两个Jack则上述方案只更新第一个，<strong>思考：如何才能批量更新数组里的相同元素呢</strong></p>

<h3 id="upsert--setoninsert">3.3.7 upsert &amp; $setOnInsert</h3>

<p>MongoDB 的update方法的三个参数是upsert，这个参数是个布尔类型，默认是false。当它为true的时候，update方法会首先查找与第一个参数匹配的记录，在用第二个参数更新之，如果找不到与第一个参数匹配的的记录，就插入一条（upsert 的名字也很有趣是个混合体：<strong>update+insert</strong>）</p>

<pre><code>&gt; db.foo.update({"count": 100}, {"$inc": {"count": 10}}, true)
&gt; db.foo.find({"count": 110})
{ "_id" : ObjectId("568a1dd53487d056d75967ad"), "count" : 110 }
</code></pre>

<p>如上，在找不到count=100这条记录的时候，自动插入一条count=100，然后再加10，最后得到一条count=110的记录</p>

<p>如果在创建文档的同时并创建字段赋初值则可使用<code>$setOnInsert</code>, 如果文档已经存在则无法更新：</p>

<pre><code>//该文档原先已存在
&gt; db.foo.find({"_id": 1})
{ "_id" : 1, "scores" : [ 9 ] }

//初始化
&gt; db.foo.update({"_id": 1},
... {$setOnInsert: { default: 100, ctime: new Date()}},
... {upsert:true}
... )

//未初始化
&gt; db.foo.find({"_id": 1})
{ "_id" : 1, "scores" : [ 9 ] }

//创建新文档并初始化
&gt; db.foo.update({"_id": 3}, {$setOnInsert: {"default":100, "ctime":new Date()}}, {upsert:true} )
&gt; db.foo.find({"_id": 3})
{ "_id" : 3, "default" : 100, "ctime" : ISODate("2016-01-04T07:31:47.325Z") }

//再次初始化，由于数据已存在则不再初始化
&gt; db.foo.update({"_id": 3}, {$setOnInsert: {"default":300, "ctime":new Date()}}, {upsert:true} )
&gt; db.foo.find({"_id": 3})
{ "_id" : 3, "default" : 100, "ctime" : ISODate("2016-01-04T07:31:47.325Z") }
</code></pre>

<h3 id="section-11">3.3.8 返回被更新的文档</h3>
<p>使用<code>findAndModify</code>,<a href="https://docs.mongodb.org/manual/reference/method/db.collection.findAndModify/">参数详情参考文档：db.collection.findAndModify()¶</a></p>

<pre><code>//query的条件不存在，创建文档,当new为false时，返回null
&gt; db.people.findAndModify({
	query: {name: "Jack"}, 
	update: { $inc: { score: 1 } }, 
	upsert: true
})
null

&gt; db.people.find({"name": "Jack"})
{ "_id" : ObjectId("568a227a3487d056d75967b0"), "name" : "Jack", "score" : 1 }

//query的条件存在，更新文档,当new为false时，返回未修改之前匹配上的文档
&gt; db.people.findAndModify({query: {name: "Jack"}, update: { $inc: { score: 10 } }, upsert: true})
{
	"_id" : ObjectId("568a227a3487d056d75967b0"),
	"name" : "Jack",
	"score" : 1
}

&gt; db.people.find({"name": "Jack"})
{ "_id" : ObjectId("568a227a3487d056d75967b0"), "name" : "Jack", "score" : 11 }

//query的条件不存在，创建文档,当new为true时，返回新文档
&gt; db.people.findAndModify({query: {name: "jack"}, update: { $inc: { score: 10 } }, upsert: true, new:true})
{
	"_id" : ObjectId("568a22b43487d056d75967b1"),
	"name" : "jack",
	"score" : 10
}
</code></pre>

<p>参考：</p>

<ul>
  <li><a href="http://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程</a></li>
  <li><a href="http://book.douban.com/subject/25798102/">《MongoDB权威指南》</a></li>
</ul>


                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/book/2015/12/31/easily-learn-to-think-independently/" data-toggle="tooltip" data-placement="top" title="《轻松学会独立思考》读书笔记">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/mongodb/2016/01/05/mongo-query/" data-toggle="tooltip" data-placement="top" title="Mongodb常用查询">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#linux基础" title="linux基础" rel="14">
                                    linux基础
                                </a>
                            
        				
                            
                				<a href="/tags/#Python" title="Python" rel="20">
                                    Python
                                </a>
                            
        				
                            
                				<a href="/tags/#linux服务器" title="linux服务器" rel="10">
                                    linux服务器
                                </a>
                            
        				
                            
                				<a href="/tags/#Mysql" title="Mysql" rel="11">
                                    Mysql
                                </a>
                            
        				
                            
                				<a href="/tags/#OS System" title="OS System" rel="7">
                                    OS System
                                </a>
                            
        				
                            
                				<a href="/tags/#python技巧" title="python技巧" rel="21">
                                    python技巧
                                </a>
                            
        				
                            
                				<a href="/tags/#redis" title="redis" rel="14">
                                    redis
                                </a>
                            
        				
                            
                				<a href="/tags/#django" title="django" rel="8">
                                    django
                                </a>
                            
        				
                            
                				<a href="/tags/#tornado" title="tornado" rel="6">
                                    tornado
                                </a>
                            
        				
                            
                				<a href="/tags/#Shell" title="Shell" rel="7">
                                    Shell
                                </a>
                            
        				
                            
                				<a href="/tags/#git" title="git" rel="5">
                                    git
                                </a>
                            
        				
                            
                				<a href="/tags/#web开发" title="web开发" rel="2">
                                    web开发
                                </a>
                            
        				
                            
                				<a href="/tags/#jQuery" title="jQuery" rel="3">
                                    jQuery
                                </a>
                            
        				
                            
                				<a href="/tags/#人生" title="人生" rel="4">
                                    人生
                                </a>
                            
        				
                            
                				<a href="/tags/#备份" title="备份" rel="2">
                                    备份
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Nginx" title="Nginx" rel="3">
                                    Nginx
                                </a>
                            
        				
                            
                				<a href="/tags/#windows服务器" title="windows服务器" rel="3">
                                    windows服务器
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#python模块" title="python模块" rel="2">
                                    python模块
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#运维" title="运维" rel="4">
                                    运维
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#python奇技淫巧" title="python奇技淫巧" rel="4">
                                    python奇技淫巧
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#python" title="python" rel="17">
                                    python
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Unix网络编程" title="Unix网络编程" rel="7">
                                    Unix网络编程
                                </a>
                            
        				
                            
                				<a href="/tags/#C" title="C" rel="2">
                                    C
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#ops" title="ops" rel="3">
                                    ops
                                </a>
                            
        				
                            
                				<a href="/tags/#book" title="book" rel="4">
                                    book
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#mongodb" title="mongodb" rel="6">
                                    mongodb
                                </a>
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/stevensia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Steven's Blog 2016
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
        hljs.initHighlightingOnLoad();
    })
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
