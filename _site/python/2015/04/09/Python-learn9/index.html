<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="个人技术总结，读书笔记，心得等 | 这里是 Stevensia的个人博客，与君共勉。">
    <meta name="keyword"  content="Python, Steven的博客, Steven Blog, linux">
    <link rel="shortcut icon" href="img/favicon.ico">

    <title>Python多线程编程(1)：基础知识 - Steven's Blog!</title>

    <link rel="canonical" href="http://universus.cn/python/2015/04/09/Python-learn9/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Steven's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About me</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/bigshows/coding1.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/bigshows/coding1.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-9 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Python" title="Python">Python</a>
                        
                    </div>
                    <h1>Python多线程编程(1)：基础知识</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by Steven's Blog on April 9, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-9 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h1 id="multithreaded-mt">一.多线程(multithreaded, MT)</h1>
<p>应用场景:Task本质异步，运行顺序是不确定性，随机性，不可预测，每个Task流都有一个要完成的目标，这些子任务可能会计算出一个中间结果，用于合并最后的结果。</p>

<h1 id="section">二.理解线程与进程</h1>
<p>## 2.1 进程(process)</p>

<p>进程是计算机中已运行程序的实体，是程序的基本执行实体，是线程的容器。它有两种运行方式：同步（循序）和异步（平行).</p>

<blockquote>
  <p>每个进程都有自己的地址空间，内存，数据栈等数据，so,能使用进程间通讯(interprocess communication, IPC)而不能直接共享信息。</p>
</blockquote>

<h2 id="section-1">2.2 进程与程序的关系</h2>
<p>程序本身只是指令、数据及其组织形式的描述，进程才是程序（那些指令和数据）的真正运行实例。若干进程有可能与同一个程序相关系，计算机以进程的形式加载多个程序到存储器中。</p>

<p>以下参考可能会更加清晰了解程序与进程的关系：</p>

<blockquote>
  <p>程序只是一个普通文件，是一个机器代码指令和数据的集合，这些指令和数据存储在磁盘上的一个可执行映象（Executable Image）中，所以，程序是一个静态的实体。这里，对可执行映象做进一步解释，可执行映象就是一个可执行文件的内容，例如，你编写了一个C源程序，最终这个源程序要经过编译、连接成为一个可执行文件后才能运行。源程序中你要定义许多变量，在可执行文件中，这些变量就组成了数据段的一部分；源程序中的许多语句，例如“ i++; for(i=0; i&lt;10; i++);”等，在可执行文件中，它们对应着许多不同的机器代码指令，这些机器代码指令经CPU执行，就完成了你所期望的工作。可以这么说：程序代表你期望完成某工作的计划和步骤，它还浮在纸面上，等待具体实现。而具体的实现过程就是由进程来完成的，进程可以认为是运行中的程序，它除了包含程序中的所有内容外，还包含一些额外的数据。程序和进程的组成如图所示。</p>
</blockquote>

<p><img src="http://oss.org.cn/kernel-book/ch04/4.1.files/image002.gif" alt="" /></p>

<h2 id="section-2">2.3 线程</h2>
<p>线程有时称为<strong>轻量级进程</strong>跟进程相似，<strong>不同的是，所有的线程运行在同一进程中，共享运行环境。</strong>*</p>

<p><strong>是操作系统能够进行运算调度的最小单位</strong>。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p>

<blockquote>
  <p>线程一般是并发执行的，正是由于这种并行和数据共享机制使得多任务更容易合作，<strong>在实际的单CPU系统中，真正的并发是不可能的，每个线程会被安排每次只运行一会儿，然后就把CPU让出来让其他线程去执行。</strong></p>
</blockquote>

<p>线程有四种状态：</p>

<ul>
  <li>产生（spawn)</li>
  <li>中断（block)</li>
  <li>非中断（unblock)</li>
  <li>退出（finish)</li>
</ul>

<p><img src="http://ww2.sinaimg.cn/mw690/aa213e02jw1ew4833e3ldj20e004yt95.jpg" alt="" /> </p>

<p>图片来源：http://python.jobbole.com/82105/</p>

<p>线程共享是很easy，但是也存在多个线程共同访问同一数据的问题，由于访问的顺序不一致，可能导致结果也不一致，这叫<strong>竞态条件(race condition)</strong></p>

<h2 id="section-3">2.4多线程</h2>

<p>线程是程序中一个<strong>单一的顺序控制流程</strong>.在单个程序中同时运行多个线程完成不同的工作,称为多线程。</p>

<p>为什么要引入多线程，目的就是为了<strong>改进性能和并发,对于某些应用程序,可以提高性能和并发性通过使用多线程。</strong></p>

<p>三. Python多线程概述</p>

<p>这节重点掌握：</p>

<ul>
  <li>全局解释器锁(GIL)的概念</li>
  <li>退出进程的动作</li>
  <li>为什么推荐使用threading</li>
</ul>

<p>首先要清楚python解释器和虚拟机:</p>

<ul>
  <li>python解释器, 将源代码转换为字节码然后执行的过程，这里的解释执行是相对于编译执行而言。更多内容参考<a href="http://www.wangyuxiong.com/archives/51258"><strong>Python解释执行原理</strong></a>&lt;/p&gt;</li>
  <li>python虚拟机, Python代码执行是由python虚拟机控制，在python虚拟机中<strong>同时只有一个线程执行，相当于单CPU运行多个进程，但是任意时刻只用一个进程在CPU中运行。</strong></li>
</ul>

<p>那我们常听到的全局解释器锁(GIL)是个什么东西呢？</p>

<h2 id="pythongil">3.1 python全局解释器锁(GIL)</h2>

<p>对python虚拟机访问是通过python全局解释器锁(global interpreter lock , GIL)控制，实现相当于一把锁，在进程与线程概念中，存在着共享内存，其他线程必须等它结束，才能使用这一块内存。GIL就是锁住然后打开的不断循环的过程，用以防止多个线程同时读写某一块内存区域。</p>

<p><img src="http://deliveryimages.acm.org/10.1145/960000/959339/7124f1.png" alt="" /></p>

<p>在多线程环境中，Python虚拟机按如下方式运行：</p>

<ol>
  <li>设置GIL</li>
  <li>切换到一个线程去执行</li>
  <li>运行：
    <ul>
      <li>指定数量的字节码的指令，或</li>
      <li>线程主动让出控制(可以调用time.sleep(0))</li>
    </ul>
  </li>
  <li>把线程设置为睡眠状态</li>
  <li>解锁GIL</li>
  <li>再次重复以上步骤</li>
</ol>

<p>我们将会在下面的系列学习<strong>GIL的局限性</strong></p>

<h2 id="section-4">3.2 线程的退出</h2>
<p>目前为止我们可以以如下方式让线程退出：</p>

<ol>
  <li>threading的join() （五颗星☆☆☆☆☆)</li>
  <li>thread.exit() （四颗星☆☆☆☆）</li>
  <li>sys.exit() (三颗星☆☆☆)</li>
  <li>抛出SystemExit异常(两颗星 ☆☆)</li>
  <li>kill命令(一颗星☆)</li>
  <li>关闭电脑。。（没有星）</li>
</ol>

<p>如上的推荐顺序一定要注意了，因为<strong>当主线程退出后，其他子线程会被清除掉，一个负责任的主线程应该了解每个线程在做什么，怎么做，以及做得如何(结果)，然后再汇总小弟们的成果组合成一个有意义的最后结果。</strong></p>

<h2 id="threading">3.3 为什么推荐使用threading</h2>
<p>原因如下：</p>

<ul>
  <li>threading更加高级，更加安全</li>
  <li>thread同步原语很少</li>
  <li>thread对线程的控制不太好，相反threading可保证子线程都退出后进程才退出（江湖大哥，让小弟先走）</li>
  <li>thread不支持守护线程</li>
</ul>

<p>参考：</p>

<p>《Python核心编程》</p>

<p>更新于：2015/11/29</p>


                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/python/2015/04/09/Python-learn8/" data-toggle="tooltip" data-placement="top" title="Python生成器小结">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/python/2015/04/09/Python-youdao/" data-toggle="tooltip" data-placement="top" title="Python 实现有道翻译命令行版">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#linux基础" title="linux基础" rel="14">
                                    linux基础
                                </a>
                            
        				
                            
                				<a href="/tags/#Python" title="Python" rel="20">
                                    Python
                                </a>
                            
        				
                            
                				<a href="/tags/#linux服务器" title="linux服务器" rel="10">
                                    linux服务器
                                </a>
                            
        				
                            
                				<a href="/tags/#Mysql" title="Mysql" rel="11">
                                    Mysql
                                </a>
                            
        				
                            
                				<a href="/tags/#OS System" title="OS System" rel="7">
                                    OS System
                                </a>
                            
        				
                            
                				<a href="/tags/#python技巧" title="python技巧" rel="21">
                                    python技巧
                                </a>
                            
        				
                            
                				<a href="/tags/#redis" title="redis" rel="14">
                                    redis
                                </a>
                            
        				
                            
                				<a href="/tags/#django" title="django" rel="8">
                                    django
                                </a>
                            
        				
                            
                				<a href="/tags/#tornado" title="tornado" rel="6">
                                    tornado
                                </a>
                            
        				
                            
                				<a href="/tags/#Shell" title="Shell" rel="7">
                                    Shell
                                </a>
                            
        				
                            
                				<a href="/tags/#git" title="git" rel="5">
                                    git
                                </a>
                            
        				
                            
                				<a href="/tags/#web开发" title="web开发" rel="2">
                                    web开发
                                </a>
                            
        				
                            
                				<a href="/tags/#jQuery" title="jQuery" rel="3">
                                    jQuery
                                </a>
                            
        				
                            
                				<a href="/tags/#人生" title="人生" rel="4">
                                    人生
                                </a>
                            
        				
                            
                				<a href="/tags/#备份" title="备份" rel="2">
                                    备份
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Nginx" title="Nginx" rel="3">
                                    Nginx
                                </a>
                            
        				
                            
                				<a href="/tags/#windows服务器" title="windows服务器" rel="3">
                                    windows服务器
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#python模块" title="python模块" rel="2">
                                    python模块
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#运维" title="运维" rel="4">
                                    运维
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#python奇技淫巧" title="python奇技淫巧" rel="4">
                                    python奇技淫巧
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#python" title="python" rel="17">
                                    python
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Unix网络编程" title="Unix网络编程" rel="7">
                                    Unix网络编程
                                </a>
                            
        				
                            
                				<a href="/tags/#C" title="C" rel="2">
                                    C
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#ops" title="ops" rel="3">
                                    ops
                                </a>
                            
        				
                            
                				<a href="/tags/#book" title="book" rel="4">
                                    book
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#mongodb" title="mongodb" rel="6">
                                    mongodb
                                </a>
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/stevensia">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Steven's Blog 2016
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
        hljs.initHighlightingOnLoad();
    })
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
